# Google Cloud Service Account Naming Constraints

## Account ID Requirements

Google Cloud service account `account_id` must adhere to these constraints:
- **Length**: 6-30 characters
- **Characters**: Lowercase letters, numbers, and hyphens only
- **Format**: Must start with a letter and end with a letter or number
- **Regex**: `^[a-z]([-a-z0-9]*[a-z0-9])?$`

## Naming Strategy Implementation

### Local Variables for Safe Naming
```hcl
locals {
  cluster_name_safe = lower(replace(var.cluster_name, "_", "-"))
  base_account_id = substr(local.cluster_name_safe, 0, 30)
  cert_manager_account_id = substr("${local.cluster_name_safe}-cert-mgr", 0, 30)
  external_dns_account_id = substr("${local.cluster_name_safe}-ext-dns", 0, 30)
}
```

### Service Account Resources
```hcl
resource "google_service_account" "default" {
  account_id   = local.base_account_id
  display_name = "Service Account created by TF for cluster ${var.cluster_name}"
}

resource "google_service_account" "cert-manager-gsa" {
  account_id   = local.cert_manager_account_id
  display_name = "Service Account created by TF for cert-manager for cluster ${var.cluster_name}"
}

resource "google_service_account" "external-dns-gsa" {
  account_id   = local.external_dns_account_id
  display_name = "Service Account created by TF for external-dns for cluster ${var.cluster_name}"
}
```

## Common Naming Patterns

### Short Cluster Names
- Input: `"test-cluster"`
- Output: `"test-cluster"`, `"test-cluster-cert-mgr"`, `"test-cluster-ext-dns"`

### Long Cluster Names (Truncation)
- Input: `"very-long-cluster-name-that-exceeds-google-service-account-limits"`
- Output: `"very-long-cluster-name-that-ex"` (truncated to 30 chars)

### Underscore Conversion
- Input: `"test_cluster_with_underscores"`
- Output: `"test-cluster-with-underscores"`

## Output Integration

### Service Account Email Outputs
```hcl
output "certmanager_service_account" {
  value = google_service_account.cert-manager-gsa.email
}

output "externaldns_service_account" {
  value = google_service_account.external-dns-gsa.email
}
```

### Cross-Module Integration
Pass service account emails to downstream modules instead of reconstructing:
```hcl
module "educates" {
  gcp_config = {
    cluster_name                = var.cluster_name
    project                     = var.project_id
    certmanager_service_account = module.gke_for_educates.gke.certmanager_service_account
    externaldns_service_account = module.gke_for_educates.gke.externaldns_service_account
  }
}
```

## Testing Patterns

### Test Configuration
```yaml
# tests/unit/test-config.yaml
gcp:
  project_id: "test-project-id"
  region: "us-central1"
```

### Validation Tests
```go
// Validate account ID length constraints
assert.LessOrEqual(t, len(accountID), tc.expectedMaxLength)

// Validate email format
assert.Contains(t, saEmail, "@"+config.GCP.ProjectID+".iam.gserviceaccount.com")
```

## Best Practices

1. **Always Sanitize**: Use `lower(replace())` for cluster names
2. **Truncate Safely**: Use `substr()` to respect 30-character limit
3. **Use Short Suffixes**: `-cert-mgr`, `-ext-dns` for derived accounts
4. **Output Emails**: Pass full emails between modules
5. **Test Constraints**: Validate naming in unit tests
description:
globs:
alwaysApply: false
---
